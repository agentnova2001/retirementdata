<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Consent 2</title>

<style>
  body {
    margin: 0;
    padding: 12px;
    font-family: Arial, sans-serif;
  }

  .container {
    display: flex;
    width: 100%;
    height: 180px;
    border: 2px solid #333;
  }

  .pad {
    position: relative;
    width: 50%;
    height: 100%;
    touch-action: none;
  }

  .agree {
    background-color: #cceeff;
    border-right: 2px solid #333;
  }

  .disagree {
    background-color: #ffffff;
  }

  .label {
    position: absolute;
    top: 6px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    font-weight: 900;
    color: #000;
    z-index: 3;
    pointer-events: none;
  }

  canvas {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 2;
  }

  button {
    margin-top: 16px;
    width: 100%;
    padding: 12px;
    font-size: 16px;
    font-weight: bold;
  }
</style>
</head>

<body>

<h3>개인정보 제3자 제공 동의</h3>

<div class="container">
  <div class="pad agree" id="agreePad">
    <div class="label">[동의]</div>
    <canvas id="agreeCanvas"></canvas>
  </div>

  <div class="pad disagree" id="disagreePad">
    <div class="label">[미동의]</div>
    <canvas id="disagreeCanvas"></canvas>
  </div>
</div>

<button onclick="submitConsent()">제출</button>

<script>
  const agreeCanvas = document.getElementById("agreeCanvas");
  const disagreeCanvas = document.getElementById("disagreeCanvas");
  const agreePad = document.getElementById("agreePad");
  const disagreePad = document.getElementById("disagreePad");

  let currentCanvas = null;
  let drawing = false;
  let hasInput = false;
  let selected = null;

  function resizeCanvas() {
    [agreeCanvas, disagreeCanvas].forEach((c) => {
      c.width = c.parentElement.clientWidth;
      c.height = c.parentElement.clientHeight;
    });
  }
  resizeCanvas();
  window.addEventListener("resize", resizeCanvas);

  function startDraw(e, canvas, type) {
    clearAll();
    selected = type;
    currentCanvas = canvas;
    drawing = true;
    hasInput = true;

    const ctx = canvas.getContext("2d");
    ctx.strokeStyle = "rgba(0, 128, 0, 0.5)";
    ctx.lineWidth = 3;
    ctx.beginPath();
    const pos = getPos(e, canvas);
    ctx.moveTo(pos.x, pos.y);
  }

  function draw(e) {
    if (!drawing || !currentCanvas) return;
    const ctx = currentCanvas.getContext("2d");
    const pos = getPos(e, currentCanvas);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
  }

  function stopDraw() {
    drawing = false;
    currentCanvas = null;
  }

  function getPos(e, canvas) {
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches ? e.touches[0] : e;
    return {
      x: touch.clientX - rect.left,
      y: touch.clientY - rect.top
    };
  }

  function clearAll() {
    [agreeCanvas, disagreeCanvas].forEach((c) => {
      c.getContext("2d").clearRect(0, 0, c.width, c.height);
    });
  }

  agreePad.addEventListener("mousedown", e => startDraw(e, agreeCanvas, "agree"));
  disagreePad.addEventListener("mousedown", e => startDraw(e, disagreeCanvas, "disagree"));
  window.addEventListener("mousemove", draw);
  window.addEventListener("mouseup", stopDraw);

  agreePad.addEventListener("touchstart", e => startDraw(e, agreeCanvas, "agree"));
  disagreePad.addEventListener("touchstart", e => startDraw(e, disagreeCanvas, "disagree"));
  window.addEventListener("touchmove", draw);
  window.addEventListener("touchend", stopDraw);

  function mergeImage() {
    const out = document.createElement("canvas");
    out.width = agreeCanvas.width * 2;
    out.height = agreeCanvas.height;
    const ctx = out.getContext("2d");

    ctx.fillStyle = "#cceeff";
    ctx.fillRect(0, 0, agreeCanvas.width, out.height);
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(agreeCanvas.width, 0, agreeCanvas.width, out.height);

    ctx.drawImage(agreeCanvas, 0, 0);
    ctx.drawImage(disagreeCanvas, agreeCanvas.width, 0);

    return out.toDataURL("image/png");
  }

  function submitConsent() {
    if (!hasInput || !selected) {
      alert("동의 또는 미동의를 표시해주세요.");
      return;
    }

    const imageData = mergeImage();

    /* ✅ Typebot 전달 변수 (Consent2 전용) */
    window.parent.postMessage({
      consent2_choice: selected,     // agree / disagree
      consent2_image: imageData      // base64 PNG
    }, "*");

    alert("제출되었습니다.");
  }
</script>

</body>
</html>