<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Consent 2</title>

<style>
body {
  margin: 0;
  padding: 12px;
  font-family: Arial, sans-serif;
}

.container {
  display: flex;
  width: 100%;
  height: 180px;
  border: 2px solid #000;
  position: relative;
}

.box {
  flex: 1;
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 22px;
  font-weight: 900;
  color: #000;
  text-align: center;
}

.agree {
  background: #ccecff;
}

.disagree {
  background: #ffffff;
  border-left: 2px solid #000;
}

.tag {
  position: absolute;
  top: 6px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 12px;
  font-weight: 700;
}

canvas {
  position: absolute;
  top: 0;
  left: 0;
}

button {
  width: 100%;
  margin-top: 12px;
  padding: 12px;
  font-size: 16px;
  font-weight: bold;
}
</style>
</head>

<body>

<div class="container" id="pad">
  <div class="box agree">
    <div class="tag">[동의]</div>
    동의
  </div>
  <div class="box disagree">
    <div class="tag">[미동의]</div>
    동의하지<br>않음
  </div>
  <canvas id="draw"></canvas>
</div>

<button onclick="submit()">제출</button>
<button onclick="resetPad()">다시하기</button>

<script>
const canvas = document.getElementById("draw");
const pad = document.getElementById("pad");
const ctx = canvas.getContext("2d");

let drawing = false;
let selectedSide = null;

function resizeCanvas() {
  canvas.width = pad.clientWidth;
  canvas.height = pad.clientHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

ctx.strokeStyle = "rgba(0,180,0,0.5)";
ctx.lineWidth = 4;
ctx.lineCap = "round";

function getSide(x) {
  return x < canvas.width / 2 ? "agree" : "disagree";
}

function getPosition(e) {
  const rect = canvas.getBoundingClientRect();
  const p = e.touches ? e.touches[0] : e;
  return {
    x: p.clientX - rect.left,
    y: p.clientY - rect.top
  };
}

function startDraw(e) {
  drawing = true;
  const pos = getPosition(e);
  selectedSide = getSide(pos.x);
  ctx.beginPath();
  ctx.moveTo(pos.x, pos.y);
}

function draw(e) {
  if (!drawing) return;
  const pos = getPosition(e);

  if (getSide(pos.x) !== selectedSide) {
    resetPad();
    drawing = false;
    return;
  }

  ctx.lineTo(pos.x, pos.y);
  ctx.stroke();
}

function stopDraw() {
  drawing = false;
}

function resetPad() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  selectedSide = null;
}

pad.addEventListener("mousedown", startDraw);
pad.addEventListener("mousemove", draw);
window.addEventListener("mouseup", stopDraw);

pad.addEventListener("touchstart", startDraw);
pad.addEventListener("touchmove", draw);
window.addEventListener("touchend", stopDraw);

function submit() {
  if (!selectedSide) {
    alert("동의 또는 미동의를 표시해주세요.");
    return;
  }

  const outputCanvas = document.createElement("canvas");
  outputCanvas.width = canvas.width;
  outputCanvas.height = canvas.height;
  const octx = outputCanvas.getContext("2d");

  // 배경
  octx.fillStyle = "#ccecff";
  octx.fillRect(0, 0, outputCanvas.width / 2, outputCanvas.height);
  octx.fillStyle = "#ffffff";
  octx.fillRect(outputCanvas.width / 2, 0, outputCanvas.width / 2, outputCanvas.height);

  // 텍스트
  octx.font = "bold 22px Arial";
  octx.fillStyle = "#000";
  octx.textAlign = "center";
  octx.fillText("동의", outputCanvas.width / 4, outputCanvas.height / 2);
  octx.fillText("동의하지 않음", outputCanvas.width * 0.75, outputCanvas.height / 2);

  // 사용자 표기 레이어
  octx.drawImage(canvas, 0, 0);

  const imageData = outputCanvas.toDataURL("image/png");

  // Typebot 전달용
  window.parent.postMessage({
    consent2_flag: selectedSide === "agree" ? "Y" : "N",
    consent2_image: imageData
  }, "*");

  // Github 테스트 팝업
  const w = window.open();
  w.document.title = "Consent2 Result";
  w.document.write("<img src='" + imageData + "' style='width:100%'>");
}
</script>

</body>
</html>