<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Consent1 - Typebot 연동</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { margin:0; font-family:sans-serif; display:flex; justify-content:center; background:#f5f5f5; }
.wrapper { width:100%; max-width:420px; padding:12px; }
.title { font-size:14px; font-weight:bold; margin-bottom:8px; }
.pad-container { position:relative; width:100%; height:110px; border:1px solid #ccc; overflow:hidden; touch-action:none; background:white; }
canvas { position:absolute; inset:0; }
</style>
</head>
<body>
<div class="wrapper">
  <div class="title">개인정보 수집이용 동의 (필수)</div>
  <div class="pad-container" id="pad">
    <canvas id="canvas"></canvas>
  </div>
</div>

<script>
const pad = document.getElementById("pad");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let drawing=false, hasDrawn=false, currentSide=null;

// 캔버스 초기화
function resize() {
  canvas.width = pad.clientWidth;
  canvas.height = pad.clientHeight;
  drawBackground();
}
window.addEventListener("resize", resize);
resize();

// 배경 그리기
function drawBackground(){
  const w=canvas.width,h=canvas.height;
  ctx.fillStyle="#cfeeff"; ctx.fillRect(0,0,w/2,h);
  ctx.fillStyle="#ffffff"; ctx.fillRect(w/2,0,w/2,h);
  ctx.strokeStyle="#bbb"; ctx.beginPath(); ctx.moveTo(w/2,0); ctx.lineTo(w/2,h); ctx.stroke();
  ctx.fillStyle="#000"; ctx.font="900 11px sans-serif"; ctx.textAlign="center"; ctx.textBaseline="top";
  ctx.fillText("[동의]", w/4,6); ctx.fillText("[미동의]", (w*3)/4,6);
  ctx.font="900 22px sans-serif"; ctx.textBaseline="middle";
  ctx.fillText("동의", w/4, h/2); ctx.fillText("동의하지", (w*3)/4, h/2-12); ctx.fillText("않음", (w*3)/4, h/2+12);
}

// 마우스/터치 좌표
function getPos(e){ 
  const r=canvas.getBoundingClientRect();
  return { x:(e.touches?e.touches[0].clientX:e.clientX)-r.left, y:(e.touches?e.touches[0].clientY:e.clientY)-r.top };
}

// 좌우 구분
function getSide(x){ return x < canvas.width/2 ? "AGREE":"DISAGREE"; }

// 그리기 시작
function start(e){ 
  const {x,y}=getPos(e); 
  const side=getSide(x); 
  if(currentSide && side!==currentSide){ resetPad(); return; } 
  currentSide=side; drawing=true; hasDrawn=true; 
  ctx.beginPath(); ctx.moveTo(x,y); 
}
function move(e){ 
  if(!drawing) return; 
  const {x,y}=getPos(e); 
  if(getSide(x)!==currentSide){ resetPad(); return; } 
  ctx.strokeStyle="rgba(0,160,0,0.5)"; ctx.lineWidth=3; ctx.lineCap="round"; 
  ctx.lineTo(x,y); ctx.stroke(); 
}
function end(){ drawing=false; ctx.closePath(); }

// 캔버스 초기화
function resetPad(){ 
  ctx.clearRect(0,0,canvas.width,canvas.height); 
  drawBackground(); 
  hasDrawn=false; currentSide=null; 
}

// 제출
function submitPad(){
  if(!hasDrawn){ alert("동의 또는 미동의 표시해주세요."); return; }

  // Typebot으로 Flag 전송
  if(window.parent){
    window.parent.postMessage({
      type:"typebot_event",
      eventName:"consent1_completed",
      payload:{ consent1_flag: currentSide }
    },"*");
  }

  // Make.com Webhook으로 이미지 전송
  const img = canvas.toDataURL("image/png");  
  fetch("https://hook.us1.make.com/YOUR_WEBHOOK_URL_HERE", {
    method:"POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ consent1_image: img, consent1_flag: currentSide })
  }).then(res=>console.log("Webhook sent", res))
    .catch(err=>console.error("Webhook error", err));
}

// 메시지 수신: Typebot 버튼 클릭 이벤트
window.addEventListener("message", (e)=>{
  if(!e.data || !e.data.type) return;
  if(e.data.type==="typebot_trigger"){
    if(e.data.action==="submit") submitPad();
    if(e.data.action==="reset") resetPad();
  }
});

// 이벤트 연결
canvas.addEventListener("mousedown", start);
canvas.addEventListener("mousemove", move);
canvas.addEventListener("mouseup", end);
canvas.addEventListener("mouseleave", end);
canvas.addEventListener("touchstart", start);
canvas.addEventListener("touchmove", move);
canvas.addEventListener("touchend", end);

</script>
</body>
</html>