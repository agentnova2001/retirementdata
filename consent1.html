<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Consent Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { margin:0; font-family:sans-serif; display:flex; justify-content:center; background:#f5f5f5; }
  .wrapper { width:100%; max-width:420px; padding:12px; }
  .pad-container { position:relative; width:100%; height:110px; border:1px solid #ccc; background:white; touch-action:none; }
  canvas { position:absolute; inset:0; width:100%; height:100%; }
  .buttons { display:flex; gap:8px; margin-top:10px; }
  button { flex:1; padding:10px 0; font-size:14px; border-radius:4px; border:none; cursor:pointer; }
  .submit { background:#4a6cf7; color:white; }
  .reset { background:#ddd; }
</style>
</head>
<body>
<div class="wrapper">
  <div class="pad-container" id="pad"><canvas id="canvas"></canvas></div>
  <div class="buttons">
    <button class="reset" onclick="resetPad()">다시하기</button>
    <button class="submit" onclick="submitPad()">제출</button>
  </div>
</div>

<script>
const pad = document.getElementById("pad");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let drawing = false; let hasDrawn = false; let currentSide = null;

function resize() {
  canvas.width = pad.clientWidth;
  canvas.height = pad.clientHeight;
  drawBackground();
}
window.addEventListener("resize", resize);
resize();

function drawBackground() {
  const w = canvas.width; const h = canvas.height;
  ctx.fillStyle = "#cfeeff"; ctx.fillRect(0,0,w/2,h);
  ctx.fillStyle = "#ffffff"; ctx.fillRect(w/2,0,w/2,h);
  ctx.strokeStyle="#bbb"; ctx.beginPath(); ctx.moveTo(w/2,0); ctx.lineTo(w/2,h); ctx.stroke();
  ctx.fillStyle="#000"; ctx.font="900 12px sans-serif"; ctx.textAlign="center";
  ctx.fillText("동의", w/4, h/2); ctx.fillText("미동의", (w*3)/4, h/2);
}

function getPos(e) {
  const r = canvas.getBoundingClientRect();
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  return { x: clientX - r.left, y: clientY - r.top };
}

function start(e) {
  const {x,y} = getPos(e);
  currentSide = x < canvas.width/2 ? "AGREE" : "DISAGREE";
  drawing = true; hasDrawn = true;
  ctx.beginPath(); ctx.moveTo(x,y);
}

function move(e) {
  if(!drawing) return;
  const {x,y} = getPos(e);
  ctx.strokeStyle = "rgba(0,160,0,0.5)"; ctx.lineWidth = 3;
  ctx.lineTo(x,y); ctx.stroke();
}

function stop() { drawing = false; ctx.closePath(); }

function resetPad() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawBackground(); hasDrawn = false;
}

function submitPad() {
  if(!hasDrawn) { alert("서명해주세요."); return; }

  console.log("전송 시도:", currentSide);

  // ✅ Typebot 연동 핵심 코드
  if (window.parent) {
    window.parent.postMessage({
      type: 'setVariables',
      variables: { "consent1_flag": currentSide }
    }, "*");
    alert("전송되었습니다! (값: " + currentSide + ")");
  } else {
    console.error("부모 창을 찾을 수 없습니다.");
  }
}

canvas.addEventListener("mousedown", start);
canvas.addEventListener("mousemove", move);
window.addEventListener("mouseup", stop);
canvas.addEventListener("touchstart", (e) => { e.preventDefault(); start(e); });
canvas.addEventListener("touchmove", (e) => { e.preventDefault(); move(e); });
canvas.addEventListener("touchend", stop);
</script>
</body>
</html>
